---
title: "Advanced Geospatial Mapping with R and Leaflet"
author: "SCIP"
date: "14/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

- Advanced geospatial mapping for humanists and social scientists
- Replication of [ABC News article](https://www.abc.net.au/news/2020-07-31/coronavirus-near-me-victoria-melbourne-postcode-data-covid19/12513684). Data provided by ABS (updated since the publication of this article)
- Merge this with mock crime data and add various parameters as needed
- Make an interactive map with two layers

## Tools

- R/Leaflet package
- Previous tutorial on geomapping for non-programmers went over user-friendly options (e.g., ArcGIS StoryMaps)
- Advantages: free and open source, more control over parameters, customisation and output
- "Programming" vs. point-and-click approaches
- Disadvantages: learning curve, potential future use, time investment

## Goals

- GIS and geospatial mapping is a semester-long course
- For a detailed introduction to advanced GIS approaches, see [this e-book](https://mgimond.github.io/Spatial/index.html)
- We will touch on the hands-on elements in this tutorial

## Basic concept

- A variable in your dataset with a geographic component (e.g., country, state, city name, full street address) for plotting points
- A way to geocode the above address
- Shapefiles that correspond with the polygon boundaries
- A shapefile is a simple, nontopological format for storing the geometric location and attribute information of geographic features. Geographic features in a shapefile can be represented by points, lines, or polygons (areas)

## Things to consider

- Data format and structure
- Recoding and reformatting
- Points or boundaries
- Single or multiple layers
- Aesthetics and color schemes
- Additional functional components
- Hosting the map online

```{r message = FALSE, warning = FALSE, out.width = "100%"}
## geospatial mapping in R
## Fri May 14, 2021

# install packages
# remotes::install_github("wfmackey/absmapsdata")
# install.packages(c("tidyverse", "sf", "tidygeocoder", "leaflet"), dependencies = TRUE)


library(tidyverse)
library(sf)
library(absmapsdata)
library(tidygeocoder)
library(leaflet)

# load in postcode polygon data from absmapsdata library
post_data <- postcode2016
str(post_data)

# load in Covid data and delete null values
covid_data <- read_csv("data/covid_data.csv")
covid_data <- covid_data

# take a look
glimpse(covid_data)

# load in location data
location_data <- read_csv("data/location_data.csv")

# take a look
glimpse(location_data)

# geocode and tally location
coords <- location_data %>%
  geocode(location, method = "osm", country = "Australia") %>%
  group_by(location, lat, long) %>%
  count()

# take a look
glimpse(coords)

# merge all datasets
covid_post_data <- left_join(post_data, covid_data, by = "postcode_num_2016")

# choose custom value cutoffs for color bins
bins <- c(0, 25, 50, 75, 100, Inf)
#bins <- c(0, 50, 100, Inf)

# choose color palettes
pal <- colorBin("Purples", domain = covid_post_data$cases, bin = bins, reverse = FALSE)

# subset/filter data by Victorian postcodes only 
covid_post_data %>%
  
  # remove NA values
  na.omit() %>%
  
  # specify coordinate reference system
  st_transform(crs = "+proj=longlat +datum=WGS84") %>%
  
  # subset dataset by Victorian postcodes and cases > 0 only
  filter(postcode_num_2016 >= 3000 & postcode_num_2016 <= 3999 |
           postcode_num_2016 >= 8000 & postcode_num_2016 <= 8999 &
           cases >= 0) %>%
  
  # leaflet mapping
  leaflet() %>%
  
  # set default zoom level around Melbourne CBD
  setView(lng = 144.9631, lat = -37.8136, 9.5) %>%
  
  # add all the base aesthetic maps desired and give them unique names
  addProviderTiles(provider = "CartoDB.Positron", group = "Grey") %>% 
  addProviderTiles(provider = "CartoDB.DarkMatter", group = "Dark") %>%
  addProviderTiles(provider = "Esri.NatGeoWorldMap", group = "Nat Geo") %>%
  
  # add choropleth layer and adjust color, weight, opacity, and stroke
  addPolygons(fillColor = ~pal(cases),
              weight = 0.5,
              opacity = 1,
              color = "white",
              dashArray = "1",
              fillOpacity = 0.7,
              stroke = TRUE,
              group = "Postcodes",
              # highlight borders as you move over the map with a mouse
              highlight = highlightOptions(weight = 2,
                                           color = "black",
                                           dashArray = "",
                                           fillOpacity = 0.3,
                                           bringToFront = TRUE),
              
              # popup/hover box text
              label = ~paste0("Postcode: ", postcode_num_2016, " Active cases: ", cases)) %>%
  
  # map legend attributes
  addLegend(pal = pal, values = ~as.numeric(cases), opacity = 0.7, 
            title = "Active Covid-19 cases", position = "bottomright") %>%
  
  # minimap as a popout
  addMiniMap(tiles = "CartoDB.Positron",
             zoomAnimation = TRUE,
             toggleDisplay = TRUE,
             minimized = TRUE,
             position = "bottomleft",
             zoomLevelOffset = -6,
             width = 200,
             height = 200) %>%
  
  # add second layer with circle markers 
  # call new dataset with long/lat columns
  addCircleMarkers(data = coords,
                   lng = ~long,
                   lat = ~lat,
                   fillColor = "orange",
                   stroke = TRUE,
                   color = "orange",
                   radius = ~n * 2,
                   fillOpacity = 1,
                   popup = ~paste0(location, "<br>", n),
                   group = "Crime") %>%
  
  # layer control menu properties
  addLayersControl(baseGroups = c("Grey", "Dark", "Nat Geo"),
                   overlayGroups = c("Postcodes", "Crime"),
                   options = layersControlOptions(collapsed = TRUE),
                   position = "topright") %>%
  
  # add an empty tile for custom attribution with link to data if desired
  addTiles(urlTemplate = "", attribution ='<a href="https://www.abs.gov.au/"> Data from ABS and my imagination!</a>') %>%
  
  # add easy buttons as deisred
  addEasyButton(easyButton(icon = "fa-globe", title = "Zoom to Level 5",
                           onClick = JS("function(btn, map){ map.setZoom(5); }"))) %>%
  addEasyButton(easyButton(icon = "fa-crosshairs", title = "Locate Me",
                           onClick = JS("function(btn, map){ map.locate({setView: true}); }"))) %>%
  
  # hide Crime layer in default map
  hideGroup("Crime")
```

## Useful links

[Install RStudio (choose FREE version)](https://www.rstudio.com/products/rstudio/download/)

[`leaflet` package in R](https://rstudio.github.io/leaflet/)

[`leaflet` package documentation](https://cran.r-project.org/web/packages/leaflet/leaflet.pdf)

[`leaflet` in Python](https://programminghistorian.org/en/lessons/mapping-with-python-leaflet)

[Leaflet base maps](https://leaflet-extras.github.io/leaflet-providers/preview/)

[`sf` package](https://r-spatial.github.io/sf/articles/sf1.html)

[`absmapsdata` package](https://github.com/wfmackey/absmapsdata)

[`tidygeocoder` package](https://rdrr.io/cran/tidygeocoder/man/tidygeocoder-package.html)

[R color palettes](https://www.datanovia.com/en/blog/top-r-color-palettes-to-know-for-great-data-visualization/)

[Free GIS options](https://gisgeography.com/free-gis-software/)

[UniMelb Resources](https://unimelb.libguides.com/GIS)

Happy mapping!







